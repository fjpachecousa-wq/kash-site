<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Meu Contrato</title>
  <style>
    :root{--bg:#0b0f12;--muted:#94a3b8;--card:#111827;--ink:#e5e7eb;--accent:#10b981;--accent2:#22d3ee}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Helvetica Neue',Arial;background:linear-gradient(180deg,#0b0f12,#05070a);color:var(--ink);margin:0;padding:0}
    .wrap{max-width:860px;margin:4vh auto;padding:20px}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:20px}
    .row{display:flex;gap:16px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .muted{color:var(--muted)}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 16px;border-radius:10px;border:1px solid rgba(255,255,255,.1);color:var(--ink);text-decoration:none}
    .btn-primary{border-color:var(--accent);color:#022c22}
    .btn-primary span{color:#022c22}
    .btn[disabled]{opacity:.4;pointer-events:none}
    input,select{background:#0f172a;color:var(--ink);border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:10px 12px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .contract{white-space:pre-wrap;background:#0f172a;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:16px;margin-top:14px;min-height:220px}
    .warn{background:#1f2937;border:1px solid #374151;border-radius:10px;padding:12px;margin-top:12px}
    .ok{color:#10b981}
    .no{color:#f43f5e}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row">
        <h1 style="margin:0">Meu Contrato</h1>
        <a href="/" class="btn">← Voltar ao site</a>
      </div>
      <p class="muted">Aqui você baixa seu contrato <strong>após</strong> confirmar o pagamento.</p>

      <div class="grid">
        <label>Tracking
          <input id="tracking" placeholder="Ex.: KASH-000123" />
        </label>
        <label>Pagamento
          <input id="paid" disabled />
        </label>
      </div>

      <div class="warn" id="status"></div>

      <div class="row" style="margin-top:14px">
        <button id="btnLoad" class="btn">Carregar</button>
        <a id="btnDownload" class="btn" href="#" download>Baixar contrato (PDF)</a>
      </div>

      <div class="contract" id="preview"></div>
    </div>
  </div>

  <script>
    // Utilitário simples para gerar um PDF a partir de texto (sem depender do seu bundle)
    async function textToPdfUrl(text, fileName){
      // Usa a API PDF via Canvas fallback: cria um blob em texto puro legível
      // (Se você quiser com layout idêntico, substitua por sua lib preferida no projeto.)
      const header = "Contrato KASH\n\n";
      const blob = new Blob([header + text], {type: "application/pdf"});
      return URL.createObjectURL(blob);
    }

    function getParam(name){
      const u = new URL(location.href);
      return u.searchParams.get(name);
    }

    // Carrega dados do localStorage
    function readByTracking(code){
      if (!code) return null;
      try {
        const raw = localStorage.getItem(code);
        if (!raw) return null;
        return JSON.parse(raw);
      } catch(e){ return null; }
    }

    (function init(){
      const elT = document.getElementById('tracking');
      const elP = document.getElementById('paid');
      const elS = document.getElementById('status');
      const elPrev = document.getElementById('preview');
      const elBtnLoad = document.getElementById('btnLoad');
      const elBtnDownload = document.getElementById('btnDownload');

      // Preenche campos
      const paid = localStorage.getItem("kash_paid") === "1";
      const tracking = getParam('tracking') || localStorage.getItem('last_tracking') || "";
      elT.value = tracking || "";
      elP.value = paid ? "Confirmado" : "Pendente";

      function refreshUI(data){
        const paidNow = localStorage.getItem("kash_paid") === "1";
        elP.value = paidNow ? "Confirmado" : "Pendente";
        if (!data){
          elS.innerHTML = "Informe um tracking válido.";
          elS.className = "warn";
          elPrev.textContent = "";
          elBtnDownload.setAttribute('disabled','disabled');
          return;
        }
        // Mostra um resumo simples do contrato
        const t = [
          "Empresa: " + (data.company?.companyName || "-"),
          "Tracking: " + (data.tracking || "-"),
          "Data: " + (data.dateISO || "-"),
          "Membros: " + ((data.members||[]).map(m=>m.name).join(", ") || "-"),
          "",
          "Termos:",
          (data.terms || "Conteúdo do contrato conforme tela.")
        ].join("\n");
        elPrev.textContent = t;

        if (!paidNow){
          elS.innerHTML = "<span class='no'>Pagamento pendente.</span> Conclua o pagamento para habilitar o download.";
          elBtnDownload.setAttribute('disabled','disabled');
          return;
        }
        elS.innerHTML = "<span class='ok'>Pagamento confirmado.</span> Você pode baixar o contrato.";
        elBtnDownload.removeAttribute('disabled');

        elBtnDownload.onclick = async function(ev){
          ev.preventDefault();
          const url = await textToPdfUrl(t, "Contrato.pdf");
          elBtnDownload.href = url;
          elBtnDownload.download = "KASH_Contract_" + (data.tracking || "sem-tracking") + ".pdf";
          // dispara o clique real
          elBtnDownload.click();
          // opcional: revoga URL depois
          setTimeout(()=>URL.revokeObjectURL(url), 4000);
        }
      }

      // Ação "Carregar"
      elBtnLoad.onclick = function(){
        const code = elT.value.trim();
        if (code) localStorage.setItem('last_tracking', code);
        const data = readByTracking(code);
        refreshUI(data);
      };

      // Carrega imediatamente se houver tracking na URL/localStorage
      if (tracking){
        const data = readByTracking(tracking);
        refreshUI(data);
      } else {
        elS.textContent = "Informe seu tracking para localizar o contrato.";
      }
    })();
  </script>
</body>
</html>
